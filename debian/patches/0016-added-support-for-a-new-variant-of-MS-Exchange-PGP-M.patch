From: Patrick Brunschwig <patrick@enigmail.net>
Date: Tue, 1 Nov 2016 17:42:27 +0100
Subject: added support for a new variant of MS-Exchange PGP/MIME messages

---
 package/fixExchangeMsg.jsm             | 4 ++--
 ui/content/enigmailMessengerOverlay.js | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/package/fixExchangeMsg.jsm b/package/fixExchangeMsg.jsm
index 7018e2f..96f606e 100644
--- a/package/fixExchangeMsg.jsm
+++ b/package/fixExchangeMsg.jsm
@@ -252,7 +252,7 @@ const EnigmailFixExchangeMsg = {
       return null;
     }
 
-    mimeHdr.initialize(bodyData.substr(encData, 500));
+    mimeHdr.initialize(bodyData.substr(encData, 5000));
     ct = mimeHdr.extractHeader("content-type", false);
     if (!ct || ct.search(/application\/octet-stream/i) < 0) {
       EnigmailLog.DEBUG("fixExchangeMsg.jsm: getCorrectedExchangeBodyData: wrong content-type of PGP/MIME data\n");
@@ -295,7 +295,7 @@ const EnigmailFixExchangeMsg = {
 
     let mimeHdr = Cc["@mozilla.org/messenger/mimeheaders;1"].createInstance(Ci.nsIMimeHeaders);
 
-    mimeHdr.initialize(bodyData.substr(encData, 500));
+    mimeHdr.initialize(bodyData.substr(encData, 5000));
     let ct = mimeHdr.extractHeader("content-type", false);
     if (!ct || ct.search(/application\/pgp-encrypted/i) < 0) {
       EnigmailLog.DEBUG("fixExchangeMsg.jsm: getCorrectediPGMailBodyData: wrong content-type of PGP/MIME data\n");
diff --git a/ui/content/enigmailMessengerOverlay.js b/ui/content/enigmailMessengerOverlay.js
index 0b8bb5d..7740eb2 100644
--- a/ui/content/enigmailMessengerOverlay.js
+++ b/ui/content/enigmailMessengerOverlay.js
@@ -704,7 +704,7 @@ Enigmail.msg = {
           mimeMsg.parts[0].parts[0].headers["content-type"][0].indexOf("text/plain") >= 0 &&
           mimeMsg.parts[0].parts[1].headers["content-type"][0].indexOf("application/pgp-encrypted") >= 0) {
           if (mimeMsg.parts[0].parts[1].headers["content-type"][0].search(/multipart\/encrypted/i) < 0 &&
-            mimeMsg.parts[0].parts[1].headers["content-type"][0].search(/PGPMIME Versions? Identification/i) >= 0 &&
+            mimeMsg.parts[0].parts[1].headers["content-type"][0].search(/PGP\/?MIME Versions? Identification/i) >= 0 &&
             mimeMsg.parts[0].parts[2].headers["content-type"][0].indexOf("application/octet-stream") >= 0 &&
             mimeMsg.parts[0].parts[2].headers["content-type"][0].indexOf("encrypted.asc") >= 0) {
             this.buggyMailType = "exchange";
