From: Patrick Brunschwig <patrick@enigmail.net>
Date: Thu, 29 Mar 2018 17:41:29 +0200
Subject: get the FPR from the imported key instead of the autocrypt store

(cherry picked from commit 2b750539f65a40941f66182a0fafca8f3ecf5e3c)
---
 package/autocrypt.jsm | 35 ++++++++++++++++++++---------------
 package/keyRing.jsm   |  2 +-
 2 files changed, 21 insertions(+), 16 deletions(-)

diff --git a/package/autocrypt.jsm b/package/autocrypt.jsm
index 7b86c83..2498b3a 100644
--- a/package/autocrypt.jsm
+++ b/package/autocrypt.jsm
@@ -243,21 +243,26 @@ var EnigmailAutocrypt = {
 
                 if (keysObj.value) {
                   importedKeys = importedKeys.concat(keysObj.value);
-
-                  // enable encryption if state (prefer-encrypt) is "mutual";
-                  // otherwise, disable it explicitely
-                  let signEncrypt = (keyArr[i].state === "mutual" ? 1 : 0);
-
-                  let ruleObj = {
-                    email: "{" + keyArr[i].email + "}",
-                    keyList: "0x" + keyArr[i].fpr,
-                    sign: signEncrypt,
-                    encrypt: signEncrypt,
-                    pgpMime: 2,
-                    flags: 0
-                  };
-
-                  EnigmailRules.insertOrUpdateRule(ruleObj);
+                  if (keysObj.value.length > 0) {
+                    let key = EnigmailKeyRing.getKeyById(keysObj.value[0]);
+
+                    // enable encryption if state (prefer-encrypt) is "mutual";
+                    // otherwise, disable it explicitely
+                    let signEncrypt = (keyArr[i].state === "mutual" ? 1 : 0);
+
+                    if (key && key.fpr) {
+                      let ruleObj = {
+                        email: "{" + keyArr[i].email + "}",
+                        keyList: "0x" + key.fpr,
+                        sign: signEncrypt,
+                        encrypt: signEncrypt,
+                        pgpMime: 2,
+                        flags: 0
+                      };
+
+                      EnigmailRules.insertOrUpdateRule(ruleObj);
+                    }
+                  }
                 }
               }
             }
diff --git a/package/keyRing.jsm b/package/keyRing.jsm
index 61efd86..0d30a53 100644
--- a/package/keyRing.jsm
+++ b/package/keyRing.jsm
@@ -695,7 +695,7 @@ var EnigmailKeyRing = {
    * @param keyBlock        String   - data containing key
    * @param keyId           String   - key ID expected to import (no meaning)
    * @param errorMsgObj     Object   - o.value will contain error message from GnuPG
-   * @param importedKeysObj Object   - [OPTIONAL] o.value will contain an array of the key IDs imported
+   * @param importedKeysObj Object   - [OPTIONAL] o.value will contain an array of the key FPRs imported
    *
    * @return Integer -  exit code:
    *      ExitCode == 0  => success
