From: Patrick Brunschwig <patrick@enigmail.net>
Date: Sun, 11 Sep 2016 17:51:13 +0200
Subject: make sure that the handler doesn't fail on S/MIME messsages if
 Enigmail cannot be initialized properly

---
 package/mimeDecrypt.jsm   | 14 ++++++++++++--
 package/pgpmimeHandler.js | 14 +++++++++++---
 2 files changed, 23 insertions(+), 5 deletions(-)

diff --git a/package/mimeDecrypt.jsm b/package/mimeDecrypt.jsm
index 4b70e5f..736dee3 100644
--- a/package/mimeDecrypt.jsm
+++ b/package/mimeDecrypt.jsm
@@ -445,12 +445,22 @@ EnigmailMimeDecrypt.prototype = {
         let proto = EnigmailMime.getProtocol(ct);
         let veri = EnigmailVerify.newVerifier(proto);
         veri.onStartRequest(this.mimeSvc, this.uri);
-        veri.onDataAvailable(null, null, gConv, 0, data.length + 1);
+        try {
+          veri.onDataAvailable(null, null, gConv, 0, data.length + 1);
+        }
+        catch (x) {
+          EnigmailLog.ERROR("mimeDecrypt.jsm: returnData(): mimeSvc.onDataAvailable failed:\n" + ex.toString());
+        }
         veri.onStopRequest(null, null, 0);
       }
       else {
         this.mimeSvc.onStartRequest(null, null);
-        this.mimeSvc.onDataAvailable(null, null, gConv, 0, data.length);
+        try {
+          this.mimeSvc.onDataAvailable(null, null, gConv, 0, data.length);
+        }
+        catch (x) {
+          EnigmailLog.ERROR("mimeDecrypt.jsm: returnData(): mimeSvc.onDataAvailable failed:\n" + ex.toString());
+        }
         this.mimeSvc.onStopRequest(null, null, 0);
       }
     }
diff --git a/package/pgpmimeHandler.js b/package/pgpmimeHandler.js
index 0cb0bf3..6dc7f95 100644
--- a/package/pgpmimeHandler.js
+++ b/package/pgpmimeHandler.js
@@ -125,12 +125,20 @@ PgpMimeHandler.prototype = {
   inStream: Cc["@mozilla.org/scriptableinputstream;1"].createInstance(Ci.nsIScriptableInputStream),
 
   onStartRequest: function(request, uri) {
-    if (!EnigmailCore.getService()) // Ensure Enigmail is initialized
+    let mimeSvc = request.QueryInterface(Ci.nsIPgpMimeProxy);
+    let ct = mimeSvc.contentType;
+
+    if (!EnigmailCore.getService()) {
+      // Ensure Enigmail is initialized
+      if (ct.search(/application\/(x-)?pkcs7-signature/i) > 0) {
+        return this.handleSmime(uri);
+      }
       return null;
+    }
+
     EnigmailLog.DEBUG("pgpmimeHandler.js: onStartRequest\n");
+    EnigmailLog.DEBUG("pgpmimeHandler.js: ct= " + ct + "\n");
 
-    let mimeSvc = request.QueryInterface(Ci.nsIPgpMimeProxy);
-    let ct = mimeSvc.contentType;
     let cth = null;
 
     if (ct.search(/^multipart\/encrypted/i) === 0) {
