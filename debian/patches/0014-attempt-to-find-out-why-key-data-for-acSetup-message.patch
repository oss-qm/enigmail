From: Patrick Brunschwig <patrick@enigmail.net>
Date: Thu, 29 Mar 2018 18:15:59 +0200
Subject: attempt to find out why key data for acSetup message is empty

(cherry picked from commit 86725c80cb7d2e4e0b285acb758ebc88843ab4ab)
---
 package/armor.jsm     | 12 ++++++------
 package/autocrypt.jsm | 10 +++++++++-
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/package/armor.jsm b/package/armor.jsm
index 756c2d6..142bd52 100644
--- a/package/armor.jsm
+++ b/package/armor.jsm
@@ -217,17 +217,17 @@ var EnigmailArmor = {
    * Remove all headers from an OpenPGP Armored message and replace them
    * with a set of new headers.
    *
-   * @param text:  String - ASCII armored message
-   * @param headers: Object - key/value pairs of new headers to insert
+   * @param armorText: String - ASCII armored message
+   * @param headers:   Object - key/value pairs of new headers to insert
    *
    * @return String - new armored message
    */
-  replaceArmorHeaders: function(text, headers) {
+  replaceArmorHeaders: function(armorText, headers) {
 
-    text = text.replace(/\r\n/g, "\n");
+    let text = armorText.replace(/\r\n/g, "\n");
     let i = text.search(/\n/);
 
-    if (i < 0) return text;
+    if (i < 0) return armorText;
     let m = text.substr(0, i + 1);
 
     for (let j in headers) {
@@ -235,7 +235,7 @@ var EnigmailArmor = {
     }
 
     i = text.search(/\n\n/);
-    if (i < 0) return text;
+    if (i < 0) return armorText;
     m += text.substr(i + 1);
 
     return m;
diff --git a/package/autocrypt.jsm b/package/autocrypt.jsm
index 2498b3a..6f53f1e 100644
--- a/package/autocrypt.jsm
+++ b/package/autocrypt.jsm
@@ -377,6 +377,12 @@ var EnigmailAutocrypt = {
 
       let keyData = EnigmailKeyRing.extractSecretKey(true, "0x" + key.fpr, {}, {});
 
+      if (!keyData || keyData.length === 0) {
+        EnigmailLog.DEBUG("autocrypt.jsm: createSetupMessage: no key found for " + identity.email + "\n");
+        reject(1);
+        return;
+      }
+
       let ac = EnigmailFuncs.getAccountForIdentity(identity);
       let preferEncrypt = ac.incomingServer.getIntValue("acPreferEncrypt") > 0 ? "mutual" : "nopreference";
 
@@ -422,8 +428,10 @@ var EnigmailAutocrypt = {
    */
   sendSetupMessage: function(identity) {
     EnigmailLog.DEBUG("autocrypt.jsm: sendSetupMessage()\n");
+
+    let self = this;
     return new Promise((resolve, reject) => {
-      this.createSetupMessage(identity).then(res => {
+      self.createSetupMessage(identity).then(res => {
         let composeFields = Cc["@mozilla.org/messengercompose/composefields;1"].createInstance(Ci.nsIMsgCompFields);
         composeFields.characterSet = "UTF-8";
         composeFields.messageId = EnigmailRNG.generateRandomString(27) + "-enigmail";
