From: Willi Mann <willi@debian.org>
Date: Wed, 3 Jul 2013 19:25:24 +0200
Subject: Fix for false positives in signature verification

Consists of upstream git commits
23d6ad3
and
8926dd2
---
 extensions/enigmail/package/enigmail.js            |   21 +++++++++++++++-----
 extensions/enigmail/package/enigmailCommon.jsm     |    2 +-
 .../ui/content/enigmailMessengerOverlay.js         |    2 +-
 3 files changed, 18 insertions(+), 7 deletions(-)

diff --git a/extensions/enigmail/package/enigmail.js b/extensions/enigmail/package/enigmail.js
index 3d5d48a..c46b123 100644
--- a/extensions/enigmail/package/enigmail.js
+++ b/extensions/enigmail/package/enigmail.js
@@ -2277,16 +2277,27 @@ Enigmail.prototype = {
                               listener, statusFlagsObj);
 
     if (!proc) {
-      return false;
+      return -1;
     }
     proc.wait();
 
-    var statusMsgObj = {};
-    var cmdLineObj   = {};
+    var retObj = {};
+
+    Ec.decryptMessageEnd (listener.stderrData, listener.exitCode, 1, true, true, nsIEnigmail.UI_INTERACTIVE, retObj);
+
+    if (listener.exitCode == 0) {
+      var detailArr = retObj.sigDetails.split(/ /);
+      var dateTime = Ec.getDateTime(detailArr[2], true, true);
+      var msg1 = retObj.errorMsg.split(/\n/)[0];
 
-    exitCode = Ec.execEnd(listener, statusFlagsObj, statusMsgObj, cmdLineObj, errorMsgObj);
+      var msg2 = Ec.getString("keyAndSigDate", ["0x"+retObj.keyId.substr(-8, 8), dateTime ]);
+      errorMsgObj.value = msg1 + "\n" + msg2;
+    }
+    else {
+      errorMsgObj.value = retObj.errorMsg;
+    }
 
-    return exitCode;
+    return listener.exitCode;
   },
 
 
diff --git a/extensions/enigmail/package/enigmailCommon.jsm b/extensions/enigmail/package/enigmailCommon.jsm
index aa3c5c4..35188d7 100644
--- a/extensions/enigmail/package/enigmailCommon.jsm
+++ b/extensions/enigmail/package/enigmailCommon.jsm
@@ -2237,7 +2237,7 @@ var EnigmailCommon = {
           validSigPat =  /VALIDSIG (\w+) (.*) (\d+) (.*)/i;
 
       } else {
-          errLines = stderrStr.value.split(/\r?\n/);
+          errLines = stderrStr.split(/\r?\n/);
 
           goodSignPat = /Good signature from (user )?"(.*)"\.?/i;
           badSignPat  =  /BAD signature from (user )?"(.*)"\.?/i;
diff --git a/extensions/enigmail/ui/content/enigmailMessengerOverlay.js b/extensions/enigmail/ui/content/enigmailMessengerOverlay.js
index cf86e09..9fbd6b7 100644
--- a/extensions/enigmail/ui/content/enigmailMessengerOverlay.js
+++ b/extensions/enigmail/ui/content/enigmailMessengerOverlay.js
@@ -1750,7 +1750,7 @@ Enigmail.msg = {
     var r = enigmailSvc.verifyAttachment(window, outFile1, outFile2, statusFlagsObj, errorMsgObj);
 
     if (r == 0)
-      EnigmailCommon.alert(window, EnigmailCommon.getString("signature.verifiedOK", [ this.getAttachmentName(origAtt) ]));
+      EnigmailCommon.alert(window, EnigmailCommon.getString("signature.verifiedOK", [ this.getAttachmentName(origAtt) ]) +"\n\n"+ errorMsgObj.value);
     else
       EnigmailCommon.alert(window, EnigmailCommon.getString("signature.verifyFailed", [ this.getAttachmentName(origAtt) ])+"\n\n"+
         errorMsgObj.value);
