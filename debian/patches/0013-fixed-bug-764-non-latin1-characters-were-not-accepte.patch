From: Patrick Brunschwig <patrick@enigmail.net>
Date: Thu, 29 Mar 2018 17:47:41 +0200
Subject: fixed bug 764: non-latin1 characters were not accepted

(cherry picked from commit b34a077d034e234c3fcdff8af7edf919ea63d252)
---
 package/funcs.jsm            | 3 ++-
 ui/content/pref-enigmail.js  | 4 ++++
 ui/content/pref-enigmail.xul | 4 ++--
 3 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/package/funcs.jsm b/package/funcs.jsm
index de3164c..e29a4cc 100644
--- a/package/funcs.jsm
+++ b/package/funcs.jsm
@@ -23,6 +23,7 @@ const Cu = Components.utils;
 Cu.import("resource://enigmail/log.jsm"); /*global EnigmailLog: false */
 Cu.import("resource://enigmail/prefs.jsm"); /*global EnigmailPrefs: false */
 Cu.import("resource://enigmail/locale.jsm"); /*global EnigmailLocale: false */
+Cu.import("resource://enigmail/data.jsm"); /*global EnigmailData: false */
 
 var gTxtConverter = null;
 
@@ -312,7 +313,7 @@ var EnigmailFuncs = {
    */
   getProtectedSubjectText: function() {
     if (EnigmailPrefs.getPref("protectedSubjectText").length > 0) {
-      return EnigmailPrefs.getPref("protectedSubjectText");
+      return EnigmailData.convertToUnicode(EnigmailPrefs.getPref("protectedSubjectText"), "utf-8");
     }
     else {
       return EnigmailLocale.getString("msgCompose.encryptedSubjectStub");
diff --git a/ui/content/pref-enigmail.js b/ui/content/pref-enigmail.js
index a1c8064..f80f361 100644
--- a/ui/content/pref-enigmail.js
+++ b/ui/content/pref-enigmail.js
@@ -138,6 +138,7 @@ function prefOnLoad() {
   displayPrefs(false, true, false);
 
   document.getElementById("enigmail_agentPath").value = EnigConvertToUnicode(EnigGetPref("agentPath"), "utf-8");
+  document.getElementById("protectedSubjectText").value = EnigConvertToUnicode(EnigGetPref("protectedSubjectText"), "utf-8");
 
   var maxIdle = -1;
   if (!gEnigmailSvc) {
@@ -432,9 +433,12 @@ function prefOnAccept() {
     document.getElementById("enigmail_agentPath").value = "";
   }
   var newAgentPath = document.getElementById("enigmail_agentPath").value;
+  var protectedSubjectText = document.getElementById("protectedSubjectText").value;
 
   displayPrefs(false, false, true);
   EnigSetPref("agentPath", EnigConvertFromUnicode(newAgentPath, "utf-8"));
+  EnigSetPref("protectedSubjectText", EnigConvertFromUnicode(protectedSubjectText, "utf-8"));
+
 
   if (gMimePartsElement &&
     (gMimePartsElement.checked != gMimePartsValue)) {
diff --git a/ui/content/pref-enigmail.xul b/ui/content/pref-enigmail.xul
index 0139a62..10498f3 100644
--- a/ui/content/pref-enigmail.xul
+++ b/ui/content/pref-enigmail.xul
@@ -385,12 +385,12 @@
 
             <hbox>
               <hbox align="center">
-                <label control="enigmail_protectedSubjectText"
+                <label control="protectedSubjectText"
                        tooltip="protectedSubjectText.tooltip"
                        value="&enigmail.protectedSubjectText.label;"/>
               </hbox>
               <hbox>
-                <textbox id="enigmail_protectedSubjectText"
+                <textbox id="protectedSubjectText"
                          tooltip="protectedSubjectText.tooltip"
                          placeholder=""
                          size="40"/>
